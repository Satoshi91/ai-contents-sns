# AIボイスドラマ投稿プラットフォーム - システム設計書

## 1. システム概要

### 1.1 システム名
AI Voice Drama Platform MVP

### 1.2 システムの目的
- AI生成音声を活用したボイスドラマの投稿・共有プラットフォーム
- クリエイターが作品を公開し、リスナーが楽しめる環境の提供
- 高品質な音声ストリーミングとユーザー体験の実現

## 2. システムアーキテクチャ

### 2.1 全体構成
```
┌─────────────────────────────────────────────────┐
│                   クライアント                    │
│          (Next.js / React / TypeScript)          │
│              + Web Audio API                     │
└─────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────┐
│                  Next.js Server                  │
│              (SSR / API Routes)                  │
└─────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────┐
│                    Firebase                      │
├─────────────────────────────────────────────────┤
│  Authentication │ Firestore │ Functions │Storage│
│                              (音声・画像)         │
└─────────────────────────────────────────────────┘
```

### 2.2 レイヤー構成

#### フロントエンド層
- **責務**: ユーザーインターフェース・音声再生機能の提供
- **技術**: Next.js, React, TypeScript, Web Audio API
- **主要コンポーネント**:
  - ページコンポーネント
  - 音声プレイヤーコンポーネント
  - UIコンポーネント
  - カスタムフック（音声制御用）

#### APIルート層
- **責務**: クライアント-Firebase間の仲介、音声メタデータ処理
- **技術**: Next.js API Routes
- **主要機能**:
  - 認証トークンの検証
  - 音声ファイルのアップロード前処理
  - 再生統計の集計
  - エラーハンドリング

#### BaaS層（Firebase）
- **責務**: データ永続化、認証、ファイルストレージ
- **技術**: Firebase各種サービス
- **主要機能**:
  - ユーザー認証管理
  - 音声ファイル・画像ストレージ
  - メタデータ管理
  - リアルタイム同期

## 3. ディレクトリ構造

```
ai-contents-sns/
├── app/                      # Next.js App Router
│   ├── (auth)/              # 認証関連ページ
│   │   ├── login/
│   │   └── signup/
│   ├── (main)/              # メインアプリケーション
│   │   ├── home/            # ホームフィード
│   │   ├── compose/         # 作品投稿
│   │   ├── play/[id]/       # 作品再生ページ
│   │   ├── profile/         # プロフィール
│   │   ├── search/          # 検索
│   │   └── ranking/         # ランキング
│   ├── api/                 # APIルート
│   │   ├── upload/          # ファイルアップロード
│   │   ├── plays/           # 再生統計
│   │   └── posts/           # 投稿管理
│   ├── layout.tsx
│   └── page.tsx
├── components/              # Reactコンポーネント
│   ├── ui/                 # 汎用UIコンポーネント
│   ├── features/           # 機能別コンポーネント
│   │   ├── audio-player/   # 音声プレイヤー
│   │   ├── post-card/      # 投稿カード
│   │   └── upload-form/    # アップロードフォーム
│   └── layouts/            # レイアウトコンポーネント
├── lib/                    # ユーティリティ
│   ├── firebase/           # Firebase設定・関数
│   ├── hooks/              # カスタムフック
│   │   └── useAudioPlayer.ts # 音声再生フック
│   ├── audio/              # 音声処理ユーティリティ
│   └── utils/              # ヘルパー関数
├── types/                  # TypeScript型定義
├── styles/                 # グローバルスタイル
├── public/                 # 静的ファイル
└── doc/                    # ドキュメント
```

## 4. データフロー

### 4.1 作品投稿フロー
```
1. ユーザーが音声ファイルを選択
2. クライアントサイドで音声ファイルの検証（形式、サイズ）
3. Firebase Storageに音声ファイルをアップロード
4. サムネイル画像をアップロード（オプション）
5. メタデータ（タイトル、説明、タグ）を入力
6. Firestoreに投稿データを保存
7. 投稿完了通知
```

### 4.2 作品再生フロー
```
1. 作品一覧から選択
2. Firebase Storageから音声URLを取得
3. Web Audio APIで音声を読み込み
4. プレイヤーUIを初期化
5. 再生開始時に再生回数をインクリメント
6. 再生位置・音量等の状態管理
7. 再生履歴の記録
```

### 4.3 フィード取得フロー
```
1. ページロード時にFirestoreから投稿を取得
2. ジャンル・ソート条件に基づくフィルタリング
3. ページネーション/無限スクロールで追加読み込み
4. サムネイル・メタデータの表示
5. リアルタイムリスナーで新着投稿を通知
```

## 5. 認証フロー

### 5.1 新規登録
```
1. ユーザーがメールアドレス/パスワードを入力
2. Firebase Authenticationでアカウント作成
3. Firestoreにユーザープロフィール作成
4. デフォルトプロフィール画像を設定
5. 自動的にログイン状態へ
6. ホーム画面へリダイレクト
```

### 5.2 ログイン
```
1. メールアドレス/パスワードを入力
2. Firebase Authenticationで認証
3. JWTトークンを取得
4. クライアントにトークンを保存
5. 前回の再生位置を復元（あれば）
6. ホーム画面へリダイレクト
```

## 6. 音声処理設計

### 6.1 音声ファイル管理
- **対応形式**: MP3, WAV, M4A
- **最大サイズ**: 100MB
- **ビットレート**: 128kbps以上推奨
- **ストレージ**: Firebase Storage with CDN

### 6.2 音声再生機能
- **ストリーミング**: プログレッシブダウンロード
- **バッファリング**: 自動バッファ管理
- **再生制御**: 再生/一時停止/シーク/音量/速度
- **波形表示**: Canvas APIによる視覚化

### 6.3 音声メタデータ
- 再生時間
- ファイルサイズ
- ビットレート
- サンプリングレート

## 7. セキュリティ設計

### 7.1 認証・認可
- Firebase Authenticationによる認証
- JWTトークンによるセッション管理
- ルートガードによるアクセス制御

### 7.2 ファイルアップロード制御
- ファイルタイプの検証
- ファイルサイズの制限
- ウイルススキャン（将来実装）
- アップロードレート制限

### 7.3 データアクセス制御
- Firestore Security Rulesによる制御
- ユーザーは自分の投稿のみ編集・削除可能
- 認証済みユーザーのみ投稿可能
- 公開/非公開設定の遵守

### 7.4 入力値検証
- クライアントサイド: フォームバリデーション
- サーバーサイド: Firebase Functionsでの検証
- XSS対策: サニタイゼーション
- SQLインジェクション対策（Firestore使用により自動的に対策）

## 8. エラーハンドリング

### 8.1 クライアントサイド
- try-catchによるエラーキャッチ
- 音声読み込みエラーの処理
- ネットワークエラーの処理
- ユーザーフレンドリーなエラーメッセージ
- エラーバウンダリーの実装

### 8.2 サーバーサイド
- Firebase Functionsでのエラーログ
- アップロード失敗時の処理
- 適切なHTTPステータスコードの返却
- エラー監視ツールの導入（将来）

## 9. パフォーマンス設計

### 9.1 フロントエンド最適化
- Code Splitting
- Lazy Loading
- 画像最適化（Next.js Image）
- 音声プリロード戦略
- バンドルサイズの最小化

### 9.2 音声ストリーミング最適化
- CDNによる配信
- 適応的ビットレート（将来実装）
- キャッシュ戦略
- プリフェッチング

### 9.3 データ取得最適化
- Firestoreクエリの最適化
- インデックスの適切な設定
- ページネーションによる分割読み込み
- メタデータのキャッシュ

## 10. スケーラビリティ

### 10.1 水平スケーリング
- Firebaseの自動スケーリング機能を活用
- Cloud Functionsの並列実行
- CDNによる音声ファイル配信
- ロードバランシング

### 10.2 将来の拡張性
- マイクロサービス化の検討
- 音声処理専用サーバーの追加
- GraphQL導入の可能性
- ElasticSearchによる高度な検索機能

## 11. モニタリング

### 11.1 アプリケーション監視
- Firebase Performance Monitoring
- 音声再生エラーの追跡
- ユーザー行動分析
- 再生完了率の測定

### 11.2 インフラ監視
- Firebase Console でのモニタリング
- ストレージ使用量の監視
- 帯域幅使用量の監視
- コスト管理

### 11.3 ユーザー体験監視
- 再生開始時間の測定
- バッファリング頻度の追跡
- ユーザーエンゲージメント分析