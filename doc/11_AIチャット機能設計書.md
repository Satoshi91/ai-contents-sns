# AIチャット機能設計書

## 1. 概要

### 1.1 機能概要
VOICARISMEプラットフォームにおけるAIチャット機能は、ユーザーの創作活動を支援するAIチャットです。
キャラクターボイス作成、台本作成、ASMR作品の企画など、音声コンテンツ制作に特化したサポートを提供します。

### 1.2 主な目的
- 作品アイデアの創出支援
- 台本・シナリオの改善提案
- キャラクター設定の深堀り
- 音声演出に関するアドバイス
- SSML形式での台本最適化
- インタラクティブなロールプレイ体験
- 協働的な台本制作プロセス

### 1.3 チャットモード機能
AIチャットは以下の3つのモードを提供し、ユーザーのニーズに応じて最適な体験を提供します：

#### **通常モード（General Mode）**
- 汎用的なAIチャット機能
- アイデア出し、質問応答、一般的な創作相談
- 軽量で直感的なチャットインターフェース

#### **ロールプレイモード（Roleplay Mode）**
- ユーザーとAIが自然なロールプレイ会話を実施
- 会話内容をそのまま音声ファイルとして保存可能
- エンターテイメント性を重視したインタラクティブ体験
- キャラクター設定に基づいた一貫性のある会話
- 感情表現やシーンに応じたSSML自動生成

#### **キャンバスモード（Canvas Mode）**
- ChatGPTやGeminiライクなデュアルペイン構成
- 左側：AIとの対話チャット
- 右側：台本制作用のテキストエディタウィンドウ
- AIとの協働によるスクリプト作成プロセス
- リアルタイムでの台本編集とフィードバック

### 1.4 ターゲットユーザー
- AIボイスドラマのクリエイター
- ASMRコンテンツ制作者
- 音声作品の企画・脚本を考えている初心者
- より高品質な作品を目指す中級者以上のクリエイター

## 2. 技術選定

### 2.1 採用技術スタック

#### **コア技術: Vercel AI SDK + shadcn/ui**

##### Vercel AI SDK を選定した理由
1. **型安全性**: TypeScript完全対応で、エンドツーエンドの型安全性を実現
2. **ストリーミング対応**: リアルタイムでのレスポンス表示が可能
3. **React統合**: `useChat`フックによる簡潔な実装
4. **プロバイダー柔軟性**: OpenAI、Anthropic、Google等の複数AIプロバイダーに対応
5. **Next.js最適化**: App Routerとの完璧な統合

##### shadcn/ui を選定した理由
1. **カスタマイズ性**: コンポーネントのソースコードを直接管理可能
2. **Tailwind CSS統合**: 既存プロジェクトとの完全な互換性
3. **アクセシビリティ**: Radix UIベースの高品質なa11y対応
4. **軽量性**: 必要なコンポーネントのみをインストール
5. **メンテナンス性**: 外部依存を最小限に抑えた設計

### 2.2 他の選択肢との比較

| 項目 | Vercel AI SDK + shadcn/ui | assistant-ui | shadcn-chat | 評価 |
|------|---------------------------|--------------|-------------|------|
| 型安全性 | ◎ 完全対応 | ○ 対応 | ○ 対応 | ◎ |
| カスタマイズ性 | ◎ 完全制御可能 | ○ プリミティブ | ○ 制限あり | ◎ |
| 既存UIとの統合 | ◎ Tailwind完全互換 | △ 要調整 | ○ Tailwind対応 | ◎ |
| 学習コスト | ○ 標準的 | △ 独自API | ○ 簡単 | ○ |
| コミュニティ | ◎ 大規模 | △ 成長中 | ○ 中規模 | ◎ |
| 将来性 | ◎ Vercel公式 | ○ 活発 | ○ 安定 | ◎ |

## 3. システムアーキテクチャ

### 3.1 全体構成

```
┌─────────────────────────────────────────────────────┐
│                    フロントエンド                      │
├─────────────────────────────────────────────────────┤
│  Next.js App Router + React 19 + TypeScript          │
│  ┌─────────────────────────────────────────────┐    │
│  │          AIチャットページ (/chat)             │    │
│  │  ┌──────────────┐  ┌──────────────────┐   │    │
│  │  │ Vercel AI SDK │  │   shadcn/ui      │   │    │
│  │  │   useChat     │  │  コンポーネント    │   │    │
│  │  └──────────────┘  └──────────────────┘   │    │
│  └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────┐
│                    APIルート                         │
├─────────────────────────────────────────────────────┤
│           /api/chat - ストリーミングAPI               │
│         Vercel AI SDK streamText 関数使用             │
└─────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────┐
│                 AIプロバイダー                        │
├─────────────────────────────────────────────────────┤
│   Phase 1: OpenAI GPT-4 / Claude 3.5               │
│   Phase 2: カスタムファインチューニングモデル           │
└─────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────┐
│                  データ永続化層                       │
├─────────────────────────────────────────────────────┤
│    Firebase Firestore - 会話履歴・スクリプト保存      │
│    Cloudflare R2 - 音声ファイル保存                  │
│    Cloudflare Images - 画像ファイル保存              │
└─────────────────────────────────────────────────────┘
```

### 3.2 データフロー

#### 基本チャットフロー
1. **ユーザー入力** → ChatInput コンポーネント
2. **リクエスト送信** → useChat フックが自動処理
3. **ストリーミング受信** → リアルタイムUI更新
4. **履歴保存** → Firestore に非同期保存
5. **セッション管理** → LocalStorage + Firestore

#### モード固有フロー

**ロールプレイモード**
1. **キャラクター設定** → プロンプト調整
2. **会話実行** → 感情・シーン分析
3. **SSML生成** → Aivis API形式変換
4. **音声生成** → Cloudflare R2保存
5. **作品データ連携** → 既存Worksシステム統合

**キャンバスモード**
1. **台本エディタ初期化** → 空のドキュメント作成
2. **AI協働編集** → リアルタイム提案・修正
3. **プレーンテキスト保存** → Firestore scripts collection
4. **SSML変換・保存** → 同時並行でSSML版作成
5. **バージョン管理** → 編集履歴の追跡

## 4. 詳細設計

### 4.1 ディレクトリ構造

```
src/
├── app/
│   ├── (main)/
│   │   └── chat/
│   │       ├── page.tsx          # メインページ
│   │       └── loading.tsx       # ローディング画面
│   └── api/
│       └── chat/
│           └── route.ts          # AI APIエンドポイント
├── components/
│   ├── features/
│   │   └── AIChat/
│   │       ├── index.tsx         # メインコンテナ
│   │       ├── ModeSelector.tsx  # モード選択UI
│   │       ├── GeneralMode.tsx   # 通常チャットモード
│   │       ├── RoleplayMode.tsx  # ロールプレイモード
│   │       ├── CanvasMode.tsx    # キャンバスモード
│   │       ├── ChatMessage.tsx   # メッセージ表示
│   │       ├── ChatInput.tsx     # 入力フィールド
│   │       ├── ChatHistory.tsx   # 履歴サイドバー
│   │       ├── PromptTemplates.tsx # テンプレート
│   │       ├── ScriptEditor.tsx  # 台本エディタ
│   │       ├── CharacterSetup.tsx # キャラクター設定
│   │       ├── VoiceRecorder.tsx # 音声録音・保存
│   │       └── SSMLEditor.tsx    # SSML編集支援
│   └── ui/
│       └── chat/                 # shadcn/ui components
│           ├── ScrollArea.tsx
│           ├── Skeleton.tsx
│           └── Separator.tsx
├── lib/
│   ├── ai/
│   │   ├── prompts.ts           # プロンプトテンプレート
│   │   ├── ssml.ts              # SSML処理ユーティリティ
│   │   └── config.ts            # AI設定
│   ├── firebase/
│   │   ├── chat.ts              # チャット履歴管理
│   │   └── scripts.ts           # スクリプト保存管理
│   ├── cloudflare/
│   │   ├── r2-audio.ts          # 音声ファイル管理
│   │   └── images.ts            # 画像管理（既存）
│   └── hooks/
│       ├── useChat.ts           # カスタムチャットフック
│       ├── useChatHistory.ts    # 履歴管理フック
│       ├── useScriptEditor.ts   # スクリプト編集フック
│       └── useVoiceRecorder.ts  # 音声録音フック
└── types/
    └── chat.ts                  # 型定義
```

### 4.2 コンポーネント設計

#### 4.2.1 メインチャットコンポーネント

```typescript
// src/components/features/AIChat/index.tsx
'use client';

import { useChat } from 'ai/react';
import { ScrollArea } from '@/components/ui/chat/ScrollArea';
import { ChatMessage } from './ChatMessage';
import { ChatInput } from './ChatInput';
import { PromptTemplates } from './PromptTemplates';

export function AIChat() {
  const { 
    messages, 
    input, 
    handleInputChange, 
    handleSubmit,
    isLoading,
    error,
    reload,
    stop
  } = useChat({
    api: '/api/chat',
    initialMessages: [],
    onResponse: (response) => {
      // 履歴保存処理
    },
    onFinish: (message) => {
      // 完了処理
    }
  });

  return (
    <div className="flex h-full">
      {/* テンプレートサイドバー */}
      <PromptTemplates onSelect={handleTemplateSelect} />
      
      {/* メインチャットエリア */}
      <div className="flex-1 flex flex-col">
        <ScrollArea className="flex-1 p-4">
          {messages.map((message) => (
            <ChatMessage 
              key={message.id} 
              message={message}
              onRegenerate={reload}
            />
          ))}
        </ScrollArea>
        
        <ChatInput
          value={input}
          onChange={handleInputChange}
          onSubmit={handleSubmit}
          isLoading={isLoading}
          onStop={stop}
        />
      </div>
    </div>
  );
}
```

#### 4.2.2 APIルート実装

```typescript
// src/app/api/chat/route.ts
import { streamText } from 'ai';
import { openai } from '@ai-sdk/openai';
import { anthropic } from '@ai-sdk/anthropic';

const SYSTEM_PROMPT = `
あなたはVOICARISME(AI生成音声によってボイスドラマなどの作品を制作し投稿できるプラットフォーム)のAIチャットです。
AIボイスドラマやASMR作品の創作を支援する専門家として、
以下の分野でユーザーをサポートしてください：

1. キャラクター設定と台本作成
2. SSML形式での音声演出最適化
3. 感情表現と話速調整のアドバイス
4. ASMRシナリオの構成提案
5. Aivis Cloud APIの活用方法

常に創造的で実践的なアドバイスを心がけてください。
`;

export async function POST(req: Request) {
  const { messages } = await req.json();

  const result = await streamText({
    model: openai('gpt-4-turbo'),
    system: SYSTEM_PROMPT,
    messages,
    temperature: 0.7,
    maxTokens: 2000,
  });

  return result.toDataStreamResponse();
}
```

### 4.3 データモデル

#### 4.3.1 チャットメッセージ型定義

```typescript
// src/types/chat.ts
export interface ChatMessage {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  metadata?: {
    model?: string;
    tokens?: number;
    ssmlContent?: string;
    templateId?: string;
  };
}

export interface ChatSession {
  id: string;
  userId: string;
  title: string;
  mode: 'general' | 'roleplay' | 'canvas';
  messages: ChatMessage[];
  createdAt: Date;
  updatedAt: Date;
  tags?: string[];
  projectId?: string; // 関連する作品ID
  // モード固有のメタデータ
  characterSettings?: CharacterSettings; // ロールプレイモード用
  scriptContent?: ScriptContent; // キャンバスモード用
}

export interface CharacterSettings {
  name: string;
  personality: string;
  background: string;
  voiceStyle?: string;
  emotionRange?: string[];
}

export interface ScriptContent {
  id: string;
  title: string;
  plainText: string; // プレーンテキスト版
  ssmlText: string; // SSML版
  version: number;
  lastModified: Date;
  collaborators?: string[]; // 共同編集者
}

export interface PromptTemplate {
  id: string;
  category: 'character' | 'scenario' | 'asmr' | 'ssml' | 'general';
  title: string;
  description: string;
  prompt: string;
  variables?: string[]; // 置換可能な変数
  examples?: string[];
}
```

#### 4.3.2 Firestoreスキーマ

```typescript
// Firestore コレクション構造
chatSessions/
  {sessionId}/
    - userId: string
    - title: string
    - mode: 'general' | 'roleplay' | 'canvas'
    - createdAt: timestamp
    - updatedAt: timestamp
    - messageCount: number
    - lastMessage: string
    - tags: string[]
    - characterSettings: object (ロールプレイモード用)
    - scriptContentId: string (キャンバスモード用)
    
    messages/ (サブコレクション)
      {messageId}/
        - role: 'user' | 'assistant'
        - content: string
        - timestamp: timestamp
        - metadata: object

scripts/
  {scriptId}/
    - sessionId: string
    - title: string
    - plainText: string      // プレーンテキスト版
    - ssmlText: string       // SSML版
    - version: number
    - createdAt: timestamp
    - lastModified: timestamp
    - userId: string
    - collaborators: string[]
    - isPublic: boolean
    
    versions/ (サブコレクション)
      {versionId}/
        - plainText: string
        - ssmlText: string
        - timestamp: timestamp
        - authorId: string
        - changeDescription: string

audioFiles/
  {audioId}/
    - sessionId: string
    - scriptId: string
    - r2Key: string          // Cloudflare R2のキー
    - url: string            // 音声ファイルURL
    - metadata: object       // 音声メタデータ
    - createdAt: timestamp
    - userId: string

promptTemplates/
  {templateId}/
    - category: string
    - title: string
    - prompt: string
    - usageCount: number
    - createdBy: string
```

## 5. 機能詳細

### 5.1 コア機能

#### 5.1.1 モードセレクタ機能
- 3つのモード間のシームレスな切り替え
- モードごとの設定保存
- セッション履歴のモード別フィルタリング

#### 5.1.2 基本的なチャット機能
- テキストメッセージの送受信
- リアルタイムストリーミング表示
- メッセージの再生成
- 会話のクリア
- モード別のシステムプロンプト適用

#### 5.1.3 プロンプトテンプレート
音声作品制作に特化したテンプレート：

```typescript
const templates = {
  character: {
    title: "キャラクター設定生成",
    prompt: "以下の設定でキャラクターを作成してください：\n性別：{gender}\n年齢：{age}\n性格：{personality}\n特徴：{features}"
  },
  asmr: {
    title: "ASMRシナリオ作成",
    prompt: "以下のASMR作品のシナリオを作成してください：\nテーマ：{theme}\n長さ：{duration}\nターゲット：{target}"
  },
  ssml: {
    title: "SSML最適化",
    prompt: "以下のテキストをSSML形式に変換し、感情表現を追加してください：\n{text}"
  }
};
```

#### 5.1.4 モード別特化機能

**ロールプレイモード**
- キャラクター設定インターフェース（名前、性格、背景）
- 会話内容の音声ファイル保存機能
- Cloudflare R2への自動アップロード
- SSML自動生成（感情・シーン対応）
- エンターテイメント性重視のUI/UX

**キャンバスモード** 
- デュアルペイン構成（チャット+エディタ）
- リアルタイム協働編集
- プレーンテキスト/SSML同期編集
- バージョン管理機能
- Firestoreへの自動保存

#### 5.1.5 SSML編集支援
- プレーンテキストからSSMLへの自動変換
- `<break>`, `<prosody>`, `<sub>` タグの挿入支援
- Aivis Cloud API用の感情タグ対応
- リアルタイムプレビュー

#### 5.1.6 コンテンツ永続化管理
- **音声ファイル**: Cloudflare R2での管理
- **スクリプト**: Firebase Firestoreでの管理
- **画像ファイル**: Cloudflare Imagesでの管理（必要時）
- バージョン履歴の自動追跡
- クロスリファレンス機能（セッション⇔コンテンツ）

#### 5.1.7 会話履歴管理
- セッション単位での保存
- モード別の履歴管理
- タイトルの自動生成
- 検索・フィルタリング
- エクスポート機能（テキスト、JSON）

### 5.2 拡張機能（Phase 2）

#### 5.2.1 Aivis Cloud API連携
- 生成したSSMLテキストの音声プレビュー
- キャラクターボイスの試聴
- 音声パラメータの調整提案

#### 5.2.2 コラボレーション機能
- チャット履歴の共有
- 共同編集モード
- コメント・フィードバック

#### 5.2.3 学習・改善
- ユーザーフィードバックの収集
- プロンプトの最適化
- 頻出パターンの学習

## 6. 実装フェーズ

### Phase 1: MVP実装（1-2週間）
- [x] 基本UIの実装（ガワ作成済み）
- [ ] Vercel AI SDK の導入
- [ ] shadcn/ui コンポーネントの追加
- [ ] モードセレクタの実装
- [ ] 基本的なチャット機能の実装
- [ ] APIルートの設定

### Phase 2: モード別機能実装（2-3週間）
- [ ] 通常モードの完成
- [ ] ロールプレイモードの基本機能
  - [ ] キャラクター設定UI
  - [ ] 音声保存機能（Cloudflare R2）
- [ ] キャンバスモードの基本機能
  - [ ] デュアルペインUI
  - [ ] スクリプト保存機能（Firestore）
- [ ] プロンプトテンプレート機能

### Phase 3: コンテンツ管理機能（2-3週間）
- [ ] SSML編集支援
- [ ] バージョン管理システム
- [ ] 会話履歴の保存と検索
- [ ] エラーハンドリング
- [ ] レスポンシブ対応

### Phase 4: 拡張機能（3-4週間）
- [ ] Aivis Cloud API連携
- [ ] 音声プレビュー機能
- [ ] 高度な検索・フィルタリング
- [ ] エクスポート機能
- [ ] 既存Worksシステムとの統合
- [ ] パフォーマンス最適化

### Phase 5: 品質向上（2週間）
- [ ] ユニットテスト
- [ ] E2Eテスト
- [ ] アクセシビリティ改善
- [ ] ドキュメント整備
- [ ] ユーザーフィードバック対応

## 7. パフォーマンス最適化

### 7.1 フロントエンド最適化
- React.memo によるメモ化
- useMemo/useCallback の適切な使用
- 仮想スクロール（大量メッセージ対応）
- 画像・アイコンの遅延読み込み

### 7.2 API最適化
- Edge Runtime の使用
- ストリーミングレスポンス
- キャッシュ戦略（Redis検討）
- レート制限の実装

### 7.3 データベース最適化
- インデックスの最適化
- バッチ処理の活用
- ページネーション
- 古いデータのアーカイブ

## 8. セキュリティ考慮事項

### 8.1 認証・認可
- Firebase Authentication連携
- セッション管理
- APIキーの安全な管理

### 8.2 入力検証
- XSS対策（DOMPurify使用）
- SQLインジェクション対策
- レート制限
- 入力文字数制限

### 8.3 データ保護
- HTTPSの強制
- 個人情報の暗号化
- GDPRコンプライアンス

## 9. モニタリング・分析

### 9.1 利用状況分析
- 使用頻度の高いテンプレート
- 平均セッション時間
- エラー率
- API使用量

### 9.2 品質メトリクス
- レスポンス時間
- 生成品質スコア
- ユーザー満足度
- 再生成率

## 10. 将来の拡張可能性

### 10.1 マルチモーダル対応
- 画像入力対応（キャラクタービジュアル）
- 音声入力対応
- 動画生成連携

### 10.2 AIモデルの進化
- ファインチューニングモデルの導入
- ローカルLLMの検討
- 専門特化型モデルの開発

### 10.3 エコシステム連携
- 外部ツールとのAPI連携
- プラグインシステム
- マーケットプレイス機能

## 11. 必要なパッケージインストール

### 11.1 基本パッケージ

```bash
# Vercel AI SDK
npm install ai @ai-sdk/openai @ai-sdk/anthropic

# shadcn/ui セットアップ
npx shadcn-ui@latest init
npx shadcn-ui@latest add button input textarea card scroll-area skeleton separator

# 追加ユーティリティ
npm install class-variance-authority clsx tailwind-merge
npm install @radix-ui/react-slot
```

### 11.2 開発依存パッケージ

```bash
# 型定義
npm install -D @types/dompurify

# テスト関連
npm install -D @testing-library/react vitest @vitest/ui
```

## 12. 環境変数設定

```env
# .env.local
# OpenAI API
OPENAI_API_KEY=your_openai_api_key

# Anthropic API (オプション)
ANTHROPIC_API_KEY=your_anthropic_api_key

# Google AI (オプション)
GOOGLE_GENERATIVE_AI_API_KEY=your_google_api_key

# Aivis Cloud API (Phase 2)
AIVIS_API_KEY=your_aivis_api_key
AIVIS_API_URL=https://api.aivis-project.com/v1

# Feature Flags
NEXT_PUBLIC_ENABLE_AI_CHAT=true
NEXT_PUBLIC_ENABLE_SSML_EDITOR=true
NEXT_PUBLIC_ENABLE_VOICE_PREVIEW=false
```

## 13. まとめ

本設計書では、VOICARISMEプラットフォームにおけるAIチャット機能の実装計画を詳細に定義しました。

### 主な特徴
1. **音声作品制作特化**: ASMRやボイスドラマ制作に最適化
2. **最新技術採用**: Vercel AI SDK + shadcn/ui による高品質実装
3. **段階的実装**: MVPから順次機能拡張
4. **将来性考慮**: Aivis Cloud APIとの連携準備

### 成功指標
- ユーザー満足度: 80%以上
- 平均応答時間: 2秒以内
- エラー率: 1%未満
- 月間アクティブユーザー: 1000人以上

本設計に基づいて実装を進めることで、クリエイターの創作活動を強力にサポートするAIチャット機能を実現します。