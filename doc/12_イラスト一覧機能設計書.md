# イラスト一覧機能設計書

## 1. 概要

### 1.1 目的
- 外部システム（image-generation-admin）で生成・管理されているimagesコレクションを活用
- マサリー表示でイラストを一覧表示し、視覚的に魅力的なギャラリーを提供
- イラストを選択してボイスを追加し、イラスト+ボイスの複合コンテンツを作成

### 1.2 システム連携
- **外部システム**: `image-generation-admin` の imagesコレクション
- **統合先**: 既存の ai-contents-sns システム
- **データ形式**: ImageData インターフェース（外部システムとの互換性維持）

## 2. データ構造設計

### 2.1 ImageData インターフェース（外部システム互換）
```typescript
export interface ImageData {
  id: string;
  request_id: string;
  storage_url: string;
  prompt?: string;
  original_filename?: string;
  created_at?: string;
  is_public?: boolean;
  rating?: string;
  views?: number;
  parent_image_id?: string;
  edit_parameters?: {
    brightness?: number;
    saturation?: number;
    contrast?: number;
    upscale_factor?: number;
  };
}

export interface ImageDocument {
  id?: string;
  image_data: ImageData;
  created_at?: unknown;
  updated_at?: unknown;
}
```

### 2.2 ImageSection 関連型定義
```typescript
export type ImagesCategory = 'all' | 'recent' | 'popular' | 'favorites';

export interface ImagesSectionConfig {
  limit?: number;
  orderBy?: 'created_at' | 'views' | 'rating';
  orderDirection?: 'desc' | 'asc';
  filters?: {
    rating?: string[];
    isPublic?: boolean;
    hasPrompt?: boolean;
  };
}

export interface ImagesGridConfig {
  sm?: number;
  md?: number; 
  lg?: number;
  xl?: number;
}
```

### 2.3 Workシステムとの違い
| 項目 | Work | ImageData |
|------|------|----------|
| 主キー | id (Work用) | id (画像生成用) |
| メタデータ | SNS向け（いいね、コメント等） | 生成系（プロンプト、パラメータ等） |
| 画像情報 | imageUrl, imageId | storage_url |
| 作成者情報 | username, displayName | request_id |
| 公開制御 | publishStatus | is_public |

## 3. 機能仕様

### 3.1 イラスト一覧表示
- **表示形式**: マサリー（Pinterest風）レイアウト
- **無限スクロール**: 自動読み込み（20件ずつ）
- **レスポンシブ**: デバイス別カラム数調整
  - スマホ: 1-2カラム
  - タブレット: 2-3カラム  
  - デスクトップ: 3-4カラム

### 3.2 フィルタリング・ソート機能
- **カテゴリフィルタ**: 全て / 最新 / 人気 / お気に入り
- **ソート**: 作成日時 / 閲覧数 / 評価順
- **検索**: プロンプトテキスト検索
- **フィルタ**: 公開/非公開、評価レベル

### 3.3 イラスト詳細表示
- **基本情報**: タイトル、プロンプト、作成日時
- **メタデータ**: 生成パラメータ、評価、閲覧数
- **アクション**: ボイス追加、お気に入り、共有
- **関連画像**: 同じリクエストID、類似プロンプト

### 3.4 ボイス追加機能
- **統合方式**: AIチャット機能と連携
- **フロー**: イラスト選択 → ボイス生成 → Work作成
- **自動セット**: Work作成時にイラスト情報を自動設定

## 4. UI/UX設計

### 4.1 レイアウト構成
```
┌─────────────────────────────────────┐
│ ナビゲーション                        │
├─────────────────────────────────────┤
│ ヘッダー [フィルタ] [ソート] [検索]    │
├─────────────────────────────────────┤
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐          │
│ │img│ │img│ │img│ │img│ マサリー    │
│ └───┘ └─┬─┘ └───┘ └─┬─┘  表示      │
│ ┌───┐   │   ┌───┐   │              │
│ │img│   │   │img│   │              │
│ └───┘   │   └───┘   │              │
│         │           │              │
└─────────┴───────────┴──────────────┘
```

### 4.2 インタラクション仕様
- **ホバー効果**: 透明度変化、スケール変化
- **クリック**: イラスト詳細ページへ遷移
- **無限スクロール**: 画面下部到達で自動読み込み
- **モーダル**: 詳細表示はモーダルまたは専用ページ

### 4.3 共通UI仕様適用
- **マウスカーソル**: `cursor-pointer` 必須
- **ハイライト効果**: `hover:shadow-lg hover:scale-105 transition-all duration-200`
- **ローディング**: Loader2 アイコン + アニメーション
- **エラー表示**: 統一されたエラーメッセージUI

## 5. 技術実装

### 5.1 ディレクトリ構成
```
src/
├── types/
│   ├── image.ts              # ImageData型定義（外部互換）
│   └── imageSection.ts       # イラスト一覧用型定義
├── lib/
│   ├── firebase/
│   │   └── images.ts         # imagesコレクション操作
│   └── hooks/
│       └── useImagesSection.ts # イラスト一覧フック
├── components/ui/
│   ├── ImageCard.tsx         # 個別イラストカード
│   ├── ImagesList.tsx        # マサリー表示リスト
│   └── ImagesSection.tsx     # セクション全体
└── app/(main)/illustrations/
    ├── page.tsx              # イラスト一覧ページ
    └── [id]/page.tsx         # イラスト詳細ページ
```

### 5.2 依存ライブラリ
- **react-masonry-css**: マサリーレイアウト実装
- **Intersection Observer API**: 無限スクロール
- **Cloudflare Images**: 画像配信最適化
- **Lucide React**: アイコンセット

### 5.3 パフォーマンス最適化
- **画像遅延読み込み**: Next.js Image コンポーネント
- **仮想スクロール**: 大量データ対応（必要に応じて）
- **キャッシュ**: React Query / SWR（必要に応じて）

## 6. データベース設計

### 6.1 Firestore コレクション構造
```
images/
└── {imageId}
    ├── id: string
    ├── image_data: ImageData
    ├── created_at: Timestamp
    └── updated_at: Timestamp
```

### 6.2 インデックス設計
```javascript
// firestore.indexes.json への追加
{
  "collectionGroup": "images", 
  "queryScope": "COLLECTION",
  "fields": [
    {"fieldPath": "image_data.is_public", "order": "ASCENDING"},
    {"fieldPath": "created_at", "order": "DESCENDING"}
  ]
},
{
  "collectionGroup": "images",
  "queryScope": "COLLECTION", 
  "fields": [
    {"fieldPath": "image_data.is_public", "order": "ASCENDING"},
    {"fieldPath": "image_data.views", "order": "DESCENDING"}
  ]
}
```

## 7. セキュリティ・権限

### 7.1 アクセス制御
- **公開画像**: 全ユーザー閲覧可能
- **非公開画像**: 生成者のみ閲覧可能（将来実装）
- **ボイス追加**: 認証ユーザーのみ

### 7.2 Firestore Security Rules
```javascript
// images コレクション
match /images/{imageId} {
  allow read: if resource.data.image_data.is_public == true;
  // 将来的には生成者チェックも追加
}
```

## 8. 実装順序

### Phase 1: 基本表示機能
1. 型定義とFirebase接続
2. 基本的なマサリー表示
3. 無限スクロール実装

### Phase 2: 詳細機能
1. フィルタリング・ソート
2. 詳細ページ実装
3. 検索機能

### Phase 3: ボイス統合
1. AIチャット連携
2. Work作成フロー
3. UI/UX最適化

## 9. 既存システムとの統合

### 9.1 Works システム連携
- イラスト選択→ボイス生成→Work作成の一連フロー
- Work作成時にImageDataからimageUrl, imageIdを自動セット
- contentTypeを'mixed'または'image'に設定

### 9.2 AIチャット機能連携  
- 「ボイスを追加」ボタンからAIチャット画面へ
- イラスト情報をコンテキストとして渡す
- 生成完了後、Workとして保存

### 9.3 GlobalAudioPlayer連携
- イラスト+ボイスのWork再生対応
- プレイリスト機能への組み込み

## 10. テスト戦略

### 10.1 単体テスト
- 型定義の妥当性
- Firebase操作関数
- UI コンポーネントの描画

### 10.2 統合テスト  
- 外部システムとのデータ連携
- 無限スクロール動作
- ボイス追加フロー

### 10.3 ユーザビリティテスト
- マサリー表示の視認性
- 操作フローの直感性
- モバイル対応の確認