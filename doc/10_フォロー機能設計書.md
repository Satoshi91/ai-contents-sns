# フォロー機能設計書

## 1. 概要

### 1.1 機能概要
ユーザー同士のフォロー・フォロワー関係を管理し、フォローしたクリエイターの新着作品を優先的に閲覧できる機能を提供します。

### 1.2 主要機能
- ユーザーのフォロー/アンフォロー
- フォロワー・フォロー中一覧の表示
- フォローフィード（フォロー先の新着作品表示）
- フォロー通知機能
- フォロー推薦機能（将来拡張）

## 2. データベース設計

### 2.1 新規コレクション

#### 2.1.1 `follows` コレクション
```typescript
interface Follow {
  id: string;                    // ドキュメントID (followerId_followingId)
  followerId: string;            // フォローする人のUID
  followingId: string;           // フォローされる人のUID
  followerData: {               // フォローする人の情報（非正規化）
    username: string;
    displayName: string;
    photoURL: string | null;
  };
  followingData: {              // フォローされる人の情報（非正規化）
    username: string;
    displayName: string;
    photoURL: string | null;
  };
  createdAt: Timestamp;         // フォロー開始日時
}
```

#### 2.1.2 `user_followers` サブコレクション（users/{uid}/followers/）
```typescript
interface UserFollower {
  id: string;                   // ドキュメントID (フォロワーのUID)
  followerData: {              // フォロワー情報（非正規化）
    username: string;
    displayName: string;
    photoURL: string | null;
  };
  createdAt: Timestamp;        // フォロー開始日時
}
```

#### 2.1.3 `user_following` サブコレクション（users/{uid}/following/）
```typescript
interface UserFollowing {
  id: string;                   // ドキュメントID (フォロー先のUID)
  followingData: {             // フォロー先情報（非正規化）
    username: string;
    displayName: string;
    photoURL: string | null;
  };
  createdAt: Timestamp;        // フォロー開始日時
}
```

#### 2.1.4 `user_feed` コレクション（フォローフィード用）
```typescript
interface UserFeed {
  id: string;                   // ドキュメントID (userId_postId)
  userId: string;               // ユーザーID（フィードの所有者）
  postId: string;               // 投稿ID
  authorId: string;             // 投稿者ID
  postData: {                   // 投稿情報（非正規化）
    title: string;
    thumbnail: string | null;
    duration: number;
    genre: string;
    playCount: number;
  };
  authorData: {                 // 投稿者情報（非正規化）
    username: string;
    displayName: string;
    photoURL: string | null;
  };
  createdAt: Timestamp;         // 投稿作成日時
  addedToFeedAt: Timestamp;     // フィードに追加された日時
}
```

### 2.2 既存コレクションの拡張

#### 2.2.1 `users` コレクション更新
既存の `followerCount` と `followingCount` を実際に使用：
```typescript
interface User {
  // ... 既存フィールド
  followerCount: number;        // フォロワー数（カウンター）
  followingCount: number;       // フォロー数（カウンター）
  // 新規追加
  isFollowable: boolean;        // フォロー可能かどうか（デフォルト: true）
  lastFollowActivity: Timestamp | null; // 最後のフォロー活動日時
}
```

#### 2.2.2 `posts` コレクション拡張
フォロー機能に関連する追加フィールド：
```typescript
interface Post {
  // ... 既存フィールド
  // 新規追加
  followerOnly: boolean;        // フォロワーのみ閲覧可能（デフォルト: false）
}
```

### 2.3 インデックス設定

#### 必須インデックス
```
Collection: follows
- followerId ASC, createdAt DESC
- followingId ASC, createdAt DESC
- createdAt DESC

Collection: user_followers (サブコレクション)
- createdAt DESC

Collection: user_following (サブコレクション)
- createdAt DESC

Collection: user_feed
- userId ASC, createdAt DESC
- userId ASC, addedToFeedAt DESC
```

### 2.4 セキュリティルール追加

```javascript
// follows コレクション
match /follows/{followId} {
  allow read: if isAuthenticated();
  allow create: if isAuthenticated() && 
                  request.resource.data.followerId == request.auth.uid;
  allow delete: if isAuthenticated() && 
                  resource.data.followerId == request.auth.uid;
}

// user_followers サブコレクション
match /users/{userId}/followers/{followerId} {
  allow read: if true; // 公開情報
  allow write: if false; // Cloud Functionsからのみ更新
}

// user_following サブコレクション
match /users/{userId}/following/{followingId} {
  allow read: if isAuthenticated() && userId == request.auth.uid;
  allow write: if false; // Cloud Functionsからのみ更新
}

// user_feed コレクション
match /user_feed/{feedId} {
  allow read: if isAuthenticated() && 
                resource.data.userId == request.auth.uid;
  allow write: if false; // Cloud Functionsからのみ更新
}
```

## 3. データ操作パターン

### 3.1 フォロー操作
1. `follows` コレクションに新しいドキュメント作成
2. フォロワーの `users/{followerId}` の `followingCount` をインクリメント
3. フォロー先の `users/{followingId}` の `followerCount` をインクリメント
4. `users/{followingId}/followers/{followerId}` にドキュメント作成
5. `users/{followerId}/following/{followingId}` にドキュメント作成
6. フォロー先の既存投稿を `user_feed` にバッチ追加（最新20件など）

### 3.2 アンフォロー操作
1. `follows/{followerId_followingId}` ドキュメント削除
2. カウンターをデクリメント
3. サブコレクションのドキュメント削除
4. `user_feed` から該当投稿者の投稿を削除

### 3.3 フォローフィード取得
1. `user_feed` から `userId` でフィルタリング
2. `addedToFeedAt` 降順でソート
3. ページネーション対応

### 3.4 新規投稿時のフィード更新
1. 投稿者のフォロワーリストを取得
2. 各フォロワーの `user_feed` に新しい投稿を追加
3. フィードサイズ制限（例：最新100件のみ保持）

## 4. フロントエンド実装

### 4.1 コンポーネント設計

#### 4.1.1 フォローボタンコンポーネント
- `FollowButton.tsx`
- フォロー/アンフォロー状態の表示・切り替え
- ローディング状態の管理
- エラーハンドリング

#### 4.1.2 フォロー関連ページ
- フォロワー一覧ページ: `app/(main)/profile/[username]/followers/page.tsx`
- フォロー中一覧ページ: `app/(main)/profile/[username]/following/page.tsx`
- フォローフィードページ: `app/(main)/feed/page.tsx`

#### 4.1.3 フォロー情報表示コンポーネント
- `FollowStats.tsx` - フォロワー・フォロー数表示
- `UserFollowList.tsx` - フォロー関係一覧表示
- `FollowFeed.tsx` - フォロー先投稿一覧

### 4.2 状態管理

#### 4.2.1 カスタムフック
- `useFollow.ts` - フォロー/アンフォロー処理
- `useFollowStats.ts` - フォロー統計情報取得
- `useFollowFeed.ts` - フォローフィード取得
- `useFollowList.ts` - フォロワー・フォロー中一覧取得

### 4.3 API設計

#### 4.3.1 フォロー関連API
```typescript
// フォロー処理
POST /api/follow
{
  "targetUserId": string
}

// アンフォロー処理
DELETE /api/follow
{
  "targetUserId": string
}

// フォロー状態確認
GET /api/follow/status?targetUserId=xxx

// フォロワー一覧取得
GET /api/users/{userId}/followers?limit=20&cursor=xxx

// フォロー中一覧取得
GET /api/users/{userId}/following?limit=20&cursor=xxx

// フォローフィード取得
GET /api/feed/following?limit=20&cursor=xxx
```

## 5. UI/UX設計

### 5.1 プロフィール画面拡張
- フォロワー・フォロー数の表示
- フォロー/アンフォローボタンの配置
- フォロワー・フォロー中一覧へのリンク

### 5.2 ホーム画面拡張
- タブ切り替え機能（すべて / フォロー中）
- フォローフィードの表示
- 新しいフォロー先の作品通知

### 5.3 フォロー推薦UI
- プロフィール下部におすすめユーザー表示
- サイドバーでの推薦表示
- フォロー完了後の関連ユーザー推薦

## 6. パフォーマンス最適化

### 6.1 データの非正規化
- フォロー関係情報の埋め込み
- フィードデータの事前計算
- カウンター情報のキャッシュ

### 6.2 フィード更新の最適化
- バッチ処理による効率的なフィード更新
- フィードサイズの制限管理
- 非アクティブユーザーのフィード削除

### 6.3 リアルタイム更新
- フォロー状態のリアルタイム同期
- 新規投稿のリアルタイム配信
- カウンター更新の即座反映

## 7. 将来拡張機能

### 7.1 フォロー通知システム
- `notifications` コレクション追加
- フォローされた時の通知
- フォロー先の新規投稿通知
- 通知設定のカスタマイズ

### 7.2 フォロー推薦システム
- `user_suggestions` コレクション
- 相互フォローの友人推薦
- 同じジャンルの投稿者推薦
- 機械学習による推薦改善

### 7.3 プライベートフォロー機能
- フォロー承認制の実装
- プライベートアカウント機能
- フォローリクエスト管理

### 7.4 フォローカテゴリ機能
- フォロー先のカテゴリ分け
- カテゴリ別フィード表示
- 重要なクリエイターの優先表示

## 8. セキュリティ考慮事項

### 8.1 スパム対策
- フォロー頻度制限
- 大量フォロー/アンフォローの検知
- 不正アカウントのブロック機能

### 8.2 プライバシー保護
- フォロー情報の公開設定
- ブロック機能の実装
- フォローリストの非表示オプション

### 8.3 データ整合性
- フォローカウンターの整合性チェック
- 孤立データの定期クリーンアップ
- 削除アカウントのフォロー関係整理

## 9. 実装優先順位

### Phase 1: 基本フォロー機能
- [ ] データベース設計の実装
- [ ] フォロー/アンフォローAPI
- [ ] 基本UIコンポーネント
- [ ] プロフィール画面の更新

### Phase 2: フォローフィード機能
- [ ] フィード生成システム
- [ ] フィードページの実装
- [ ] ホーム画面のタブ機能
- [ ] リアルタイム更新

### Phase 3: 拡張機能
- [ ] フォロー通知システム
- [ ] フォロー推薦機能
- [ ] パフォーマンス最適化
- [ ] セキュリティ機能強化

## 10. テスト計画

### 10.1 単体テスト
- フォロー/アンフォロー処理
- フィード生成ロジック
- カウンター更新処理

### 10.2 結合テスト
- フロントエンド・バックエンド連携
- リアルタイム更新機能
- 大量データでのパフォーマンス

### 10.3 ユーザビリティテスト
- フォロー機能の使いやすさ
- フィード表示の見やすさ
- 推薦機能の有効性