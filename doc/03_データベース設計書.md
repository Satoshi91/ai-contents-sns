# AIボイスドラマ投稿プラットフォーム - データベース設計書

## 1. データベース概要

### 1.1 使用データベース
- **Cloud Firestore** (NoSQL Document Database)
- リアルタイム同期機能
- 自動スケーリング
- オフラインサポート

### 1.2 データモデリング方針
- ドキュメント指向設計
- 非正規化によるクエリ最適化
- コレクショングループの活用
- 複合インデックスの設定
- 音声ファイルメタデータの効率的管理

## 2. コレクション設計

### 2.1 users コレクション

#### ドキュメント構造
```typescript
interface User {
  uid: string;                 // Firebase Auth UID (Document ID)
  username: string;             // ユーザー名 (@なし、一意)
  displayName: string;          // 表示名
  email: string;                // メールアドレス
  photoURL: string | null;      // プロフィール画像URL
  bio: string;                  // 自己紹介文 (最大500文字)
  createdAt: Timestamp;         // アカウント作成日時
  updatedAt: Timestamp;         // 最終更新日時
  postCount: number;            // 投稿数（カウンター）
  totalPlays: number;           // 総再生回数
  followerCount: number;        // フォロワー数（将来用）
  followingCount: number;       // フォロー数（将来用）
}
```

#### インデックス
- `username` (単一フィールド、昇順)
- `createdAt` (単一フィールド、降順)
- `totalPlays` (単一フィールド、降順)

#### セキュリティルール
```javascript
// 読み取り: 全ユーザー
// 作成: 認証済みかつ自分のUID
// 更新: 認証済みかつ自分のドキュメント
// 削除: 不可
```

### 2.2 posts コレクション

#### ドキュメント構造
```typescript
interface Post {
  id: string;                   // ドキュメントID (自動生成)
  title: string;                // タイトル (最大100文字)
  description: string;          // 説明文 (最大1000文字)
  authorId: string;             // 投稿者のUID
  authorData: {                 // 投稿者情報（非正規化）
    username: string;
    displayName: string;
    photoURL: string | null;
  };
  audioFile: {                  // 音声ファイル情報
    url: string;                // Firebase Storage URL
    filename: string;           // 元ファイル名
    duration: number;           // 再生時間（秒）
    fileSize: number;           // ファイルサイズ（バイト）
    format: string;             // ファイル形式 (mp3, wav, m4a)
    bitRate: number | null;     // ビットレート
  };
  thumbnail: {                  // サムネイル画像（オプション）
    url: string | null;
    filename: string | null;
  };
  tags: string[];               // タグ配列 (最大10個)
  genre: string;                // ジャンル
  isPublic: boolean;            // 公開/非公開
  createdAt: Timestamp;         // 投稿日時
  updatedAt: Timestamp;         // 更新日時
  playCount: number;            // 再生回数
  favoriteCount: number;        // お気に入り数（将来用）
  commentCount: number;         // コメント数（将来用）
}
```

#### インデックス
- `createdAt` (単一フィールド、降順)
- `authorId, createdAt` (複合インデックス、昇順、降順)
- `playCount` (単一フィールド、降順)
- `genre, createdAt` (複合インデックス、昇順、降順)
- `tags array-contains, createdAt` (複合インデックス、配列、降順)
- `isPublic, createdAt` (複合インデックス、昇順、降順)

#### セキュリティルール
```javascript
// 読み取り: isPublic=true または投稿者本人
// 作成: 認証済みユーザー
// 更新: 投稿者本人のみ
// 削除: 投稿者本人のみ
```

### 2.3 plays コレクション（再生履歴）

#### ドキュメント構造
```typescript
interface Play {
  id: string;                   // ドキュメントID (自動生成)
  userId: string;               // 再生ユーザーのUID
  postId: string;               // 再生された投稿ID
  postData: {                   // 投稿情報（非正規化）
    title: string;
    authorId: string;
    duration: number;
  };
  playedAt: Timestamp;          // 再生日時
  duration: number;             // 実際に再生した時間（秒）
  completionRate: number;       // 再生完了率 (0-1)
  deviceType: string;           // デバイス種別 (web, mobile)
}
```

#### インデックス
- `userId, playedAt` (複合インデックス、昇順、降順)
- `postId, playedAt` (複合インデックス、昇順、降順)
- `playedAt` (単一フィールド、降順)

### 2.4 favorites コレクション（お気に入り）

#### ドキュメント構造
```typescript
interface Favorite {
  id: string;                   // ドキュメントID (userId_postId)
  userId: string;               // ユーザーID
  postId: string;               // 投稿ID
  postData: {                   // 投稿情報（非正規化）
    title: string;
    authorId: string;
    thumbnail: string | null;
  };
  createdAt: Timestamp;         // お気に入り登録日時
}
```

#### インデックス
- `userId, createdAt` (複合インデックス、昇順、降順)
- `postId, createdAt` (複合インデックス、昇順、降順)

### 2.5 usernames コレクション（ユーザー名の一意性保証）

#### ドキュメント構造
```typescript
interface Username {
  uid: string;                  // ユーザーのUID
  createdAt: Timestamp;         // 登録日時
}
```

#### 用途
- ユーザー名の重複チェック
- ドキュメントIDをユーザー名として使用

### 2.6 analytics コレクション（分析データ）

#### ドキュメント構造
```typescript
interface Analytics {
  id: string;                   // YYYY-MM-DD形式の日付
  date: Timestamp;              // 集計日
  totalPlays: number;           // 総再生回数
  totalUsers: number;           // アクティブユーザー数
  totalPosts: number;           // 総投稿数
  popularGenres: Array<{        // 人気ジャンル
    genre: string;
    count: number;
  }>;
  topPosts: Array<{             // 人気投稿
    postId: string;
    playCount: number;
  }>;
}
```

## 3. Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ヘルパー関数
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isValidPost() {
      return request.resource.data.title is string &&
             request.resource.data.title.size() > 0 &&
             request.resource.data.title.size() <= 100 &&
             request.resource.data.description is string &&
             request.resource.data.description.size() <= 1000 &&
             request.resource.data.audioFile.url is string &&
             request.resource.data.genre is string &&
             request.resource.data.tags is list &&
             request.resource.data.tags.size() <= 10 &&
             request.resource.data.isPublic is bool;
    }
    
    function isValidUser() {
      return request.resource.data.username is string &&
             request.resource.data.username.size() >= 3 &&
             request.resource.data.username.size() <= 20 &&
             request.resource.data.displayName is string &&
             request.resource.data.displayName.size() > 0 &&
             request.resource.data.displayName.size() <= 50 &&
             request.resource.data.bio.size() <= 500;
    }
    
    // users コレクション
    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId) && isValidUser();
      allow update: if isOwner(userId) && isValidUser();
      allow delete: if false;
    }
    
    // posts コレクション
    match /posts/{postId} {
      allow read: if resource.data.isPublic == true ||
                    (isAuthenticated() && resource.data.authorId == request.auth.uid);
      allow create: if isAuthenticated() && 
                      isValidPost() &&
                      request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && 
                      resource.data.authorId == request.auth.uid &&
                      isValidPost();
      allow delete: if isAuthenticated() && 
                      resource.data.authorId == request.auth.uid;
    }
    
    // plays コレクション
    match /plays/{playId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // favorites コレクション
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // usernames コレクション
    match /usernames/{username} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                      request.resource.data.uid == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && 
                      resource.data.uid == request.auth.uid;
    }
    
    // analytics コレクション
    match /analytics/{date} {
      allow read: if true;
      allow write: if false; // Cloud Functionsからのみ更新
    }
  }
}
```

## 4. データ操作パターン

### 4.1 ユーザー登録時
1. Firebase Authenticationでユーザー作成
2. `usernames`コレクションでユーザー名の重複チェック
3. `usernames`コレクションにドキュメント作成
4. `users`コレクションにユーザー情報作成

### 4.2 ボイスドラマ投稿時
1. 音声ファイルをFirebase Storageにアップロード
2. サムネイル画像をアップロード（オプション）
3. 音声メタデータ（時間、サイズ等）を抽出
4. 投稿内容のバリデーション
5. `posts`コレクションに投稿作成
6. `users`コレクションの`postCount`をインクリメント

### 4.3 作品再生時
1. 投稿情報を取得
2. 認証状態と公開設定をチェック
3. 音声URLをFirebase Storageから取得
4. 再生開始時に`plays`コレクションに記録
5. `posts`コレクションの`playCount`をインクリメント
6. 再生完了時に完了率を記録

### 4.4 フィード取得時
1. `posts`コレクションを`createdAt`降順でクエリ
2. `isPublic = true`の条件でフィルタリング
3. ジャンルやタグによる追加フィルタリング
4. ページネーション用のカーソルを使用
5. リアルタイムリスナーで新規投稿を監視

### 4.5 お気に入り機能
1. `favorites`コレクションで重複チェック
2. お気に入り登録/解除
3. `posts`コレクションの`favoriteCount`を更新

## 5. インデックス設定

### 必須インデックス
```
Collection: posts
- createdAt DESC
- authorId ASC, createdAt DESC  
- playCount DESC
- genre ASC, createdAt DESC
- tags array-contains, createdAt DESC
- isPublic ASC, createdAt DESC

Collection: users
- username ASC
- createdAt DESC
- totalPlays DESC

Collection: plays
- userId ASC, playedAt DESC
- postId ASC, playedAt DESC
- playedAt DESC

Collection: favorites
- userId ASC, createdAt DESC
- postId ASC, createdAt DESC
```

## 6. パフォーマンス最適化

### 6.1 データの非正規化
- 投稿に投稿者情報を埋め込み（authorData）
- お気に入りに投稿情報を埋め込み（postData）
- 再生履歴に投稿情報を埋め込み（postData）
- JOINクエリを回避

### 6.2 カウンターの管理
- Cloud Functionsでカウンターを更新
- 分散カウンターパターンの採用（大規模時）
- 再生回数の非同期更新

### 6.3 クエリ最適化
- 適切なインデックスの設定
- limitとカーソルベースページネーション
- where句の効率的な使用
- 複合クエリの最適化

### 6.4 音声ファイル最適化
- Firebase Storageのトークンベースアクセス
- CDNキャッシュの活用
- プリフェッチング戦略

## 7. バックアップとリカバリ

### 7.1 バックアップ戦略
- Firebaseの自動バックアップ機能
- 定期的なエクスポート（日次）
- 音声ファイルの冗長化
- メタデータの個別バックアップ

### 7.2 リカバリ手順
- Point-in-timeリカバリ
- データ整合性チェック
- 音声ファイルとメタデータの整合性確認
- ロールバック手順の文書化

## 8. データ移行

### 8.1 スキーマ変更時
- Cloud Functionsによるバッチ更新
- 段階的な移行戦略
- 後方互換性の維持
- 音声メタデータの更新処理

### 8.2 データインポート/エクスポート
- Firebase Admin SDKの使用
- 音声ファイルの一括処理
- メタデータの検証プロセス
- 進捗監視機能

## 9. 監視とメトリクス

### 9.1 監視項目
- ドキュメント読み取り/書き込み数
- ストレージ使用量（音声ファイル）
- クエリパフォーマンス
- エラー率
- 再生成功率
- アップロード成功率

### 9.2 アラート設定
- ストレージ使用量の閾値超過
- 再生エラー率の上昇
- アップロード失敗率の上昇
- パフォーマンス劣化
- コスト上昇アラート

## 10. データ保持・削除ポリシー

### 10.1 データ保持期間
- ユーザーデータ: アカウント削除まで永続
- 投稿データ: ユーザー削除まで永続
- 再生履歴: 2年間保持
- 分析データ: 5年間保持

### 10.2 データ削除処理
- ユーザー削除時のカスケード削除
- 音声ファイルの物理削除
- GDPR対応のデータ削除機能