# タグ機能設計書

## 概要
AIボイスドラマ投稿プラットフォームにタグ機能を追加し、作品の分類・検索・発見性を向上させる機能を実装します。

## 機能要件

### 1. タグの基本仕様
- **タグ形式**: 日本語・英数字・記号（#@を除く）
- **文字数制限**: 1タグあたり最大20文字
- **タグ数制限**: 1作品あたり最大10個
- **重複制限**: 同一作品内でのタグ重複は不可
- **大文字小文字**: 区別しない（統一して小文字で保存）

### 2. 作品投稿時のタグ機能
- compose画面にタグ入力フィールドを追加
- リアルタイムでタグ候補を表示（既存タグから）
- タグの追加・削除が可能
- バリデーションエラーの表示

### 3. タグ表示機能
- 作品一覧でのタグ表示（最大3個まで）
- 作品詳細でのタグ全件表示
- タグクリックで関連作品を検索

### 4. タグ専用ページ（/tags）
- **タグ検索**: キーワードでタグを検索
- **トレンドタグ**: 24時間/7日間/30日間の人気タグ
- **カテゴリー別タグ**: ジャンル・用途別のタグ分類
- **全タグ一覧**: 使用回数順でのタグ表示

### 5. 検索機能強化
- 既存の検索機能にタグフィルターを追加
- タグ単体での検索機能
- 複数タグでのAND/OR検索

## データ構造

### タグ管理アーキテクチャ

タグの詳細情報（R18フラグ、カテゴリー情報等）を効率的に管理するため、**分離コレクション + ハイブリッドアプローチ**を採用します。

### 1. tagsコレクション（マスタ管理）
```typescript
export interface Tag {
  id: string;                    // タグの一意識別子（例: "tag_romance"）
  name: string;                  // 表示名（例: "恋愛"）
  slug: string;                  // URL用スラッグ（例: "romance"）
  category: TagCategory;         // カテゴリー
  metadata: {
    isR18: boolean;              // R18フラグ
    ageRating: 'all' | '12+' | '15+' | '18+';  // 年齢制限
    color: string;               // 表示色（例: "#FF6B9D"）
    icon?: string;               // アイコン名（例: "heart"）
    description?: string;        // タグの説明
  };
  stats: {
    usageCount: number;          // 使用回数
    trendScore: number;          // トレンドスコア（0-10）
    lastUsed: Date;              // 最終使用日時
  };
  createdAt: Date;
  updatedAt: Date;
  isActive: boolean;             // アクティブフラグ（管理用）
}

export type TagCategory = 
  | 'genre'        // ジャンル（恋愛、SF、ホラー等）
  | 'mood'         // 雰囲気（感動、コメディ、シリアス等）  
  | 'usage'        // 用途（作業用、睡眠用、リラックス等）
  | 'target'       // 対象（子供向け、大人向け等）
  | 'length'       // 長さ（短編、長編等）
  | 'style'        // スタイル（朗読、ドラマ、ASMR等）
  | 'other';       // その他
```

### 2. worksコレクション（作品データ）
```typescript
export interface Work {
  // 既存フィールド...
  tags: WorkTag[];               // タグ情報（非正規化データ含む）
  tagIds: string[];              // タグIDのみ（検索用）
  tagNames: string[];            // タグ名のみ（検索用）
  isR18Work: boolean;            // 作品レベルのR18フラグ（タグから自動算出）
  contentRating: 'all' | '12+' | '15+' | '18+';  // 作品の年齢制限
}

export interface WorkTag {
  id: string;                    // タグID
  name: string;                  // タグ名（検索用非正規化）
  category: TagCategory;         // カテゴリー（フィルタリング用）
  isR18: boolean;               // R18フラグ（フィルタリング用）
  color: string;                // 表示色
}

export interface CreateWorkInput {
  // 既存フィールド...
  tags?: string[];              // タグIDまたはタグ名の配列
}
```

### 3. 検索・統計用データ構造
```typescript
export interface TagSearchResult {
  tag: Tag;
  relatedTags: string[];        // 関連タグ
  worksCount: number;          // 関連作品数
}

export interface TrendingTag {
  tag: Tag;
  trendScore: number;
  growthRate: number;          // 成長率
  period: '24h' | '7d' | '30d';
}
```

### データ管理の利点

1. **柔軟な情報管理**: タグごとにR18フラグ、カテゴリー、色などを設定
2. **高速検索**: 非正規化データによる効率的なクエリ実行
3. **統計機能**: 使用回数、トレンドスコアの一元管理
4. **管理機能**: タグの統合、編集、非アクティブ化が容易
5. **拡張性**: 新しいメタデータの追加が簡単

## UI設計

### 1. タグ入力コンポーネント（TagInput）
- **位置**: compose画面のキャプション入力の下
- **機能**:
  - テキスト入力でタグを追加（Enter/カンマで区切り）
  - 既存タグの候補表示（オートコンプリート）
  - 追加済みタグの表示・削除機能
  - 文字数・個数制限の表示

### 2. タグ表示コンポーネント（TagDisplay）
- **デザイン**: 角丸の小さなバッジ形式
- **色**: 青系の背景（#EBF8FF）、テキスト（#1E40AF）
- **ホバー効果**: cursor-pointer、色の濃淡変化
- **サイズ**: 小（作品一覧）、中（詳細画面）

### 3. タグページレイアウト
```
┌─────────────────────────────────────┐
│ タグ検索フォーム                        │
├─────────────────────────────────────┤
│ トレンドタグ（24時間/7日/30日）            │
├─────────────────────────────────────┤
│ カテゴリー別タグ                        │
│ - ジャンル (SF、恋愛、ホラー等)           │
│ - 用途 (作業用、睡眠用、リラックス等)       │
├─────────────────────────────────────┤
│ 全タグ一覧（ページネーション）              │
└─────────────────────────────────────┘
```

## Firebase実装

### 1. 作品作成・更新時のタグ処理
```typescript
// createWork, updateWorkでtags配列を処理
// タグの正規化（小文字化、空白削除）を実装
```

### 2. タグ検索クエリ
```typescript
// array-contains-any を使用したタグフィルタリング
query(worksCollection, where('tags', 'array-contains-any', selectedTags))
```

### 3. タグ統計の集計
```typescript
// 定期的なバッチ処理またはCloud Functionsで統計情報を更新
// tagsCollection で各タグの使用回数を管理
```

## バリデーション

### フロントエンド（Zod）
```typescript
const tagSchema = z.string()
  .min(1, 'タグは1文字以上である必要があります')
  .max(20, 'タグは20文字以内である必要があります')
  .regex(/^[a-zA-Z0-9ひらがなカタカナ一-龯ー\s\-_]+$/, '使用できない文字が含まれています');

const createWorkSchema = z.object({
  // 既存フィールド...
  tags: z.array(tagSchema).max(10, 'タグは最大10個まで設定できます').optional()
});
```

### バックエンド（Firebase）
- 同一バリデーションルールをFirebase側でも適用
- 重複タグの除去処理

## ナビゲーション

### サイドバーメニューに追加
- アイコン: Hash（#）または Tag
- ラベル: 「タグ」
- 位置: 検索の下、いいね一覧の上

## 実装フェーズ

### Phase 1: 基本機能
1. データ構造の拡張
2. タグ入力コンポーネントの実装
3. 作品投稿時のタグ処理
4. タグ表示コンポーネントの実装

### Phase 2: 検索機能
1. タグによる作品検索機能
2. 既存検索機能への統合
3. タグクリック検索の実装

### Phase 3: タグページ
1. タグ専用ページの作成
2. トレンドタグの実装
3. タグ統計機能の実装
4. サイドバーナビゲーションの追加

## パフォーマンス考慮

### インデックス
- Firestoreでのtags配列フィールドにインデックス設定
- 複合インデックス（createdAt + tags）の検討

### キャッシュ戦略
- 人気タグの定期的なキャッシュ更新
- タグ候補のローカルキャッシュ

## セキュリティ

### 入力値検証
- XSS対策のためのHTMLエスケープ
- SQLインジェクション対策（Firebaseでは自動）
- 不適切なタグの検出・フィルタリング

### スパム対策
- 同一ユーザーの大量タグ投稿の制限
- 不適切タグの報告機能（将来実装）

## 今後の拡張予定

### 1. タグの階層化
- 親タグ・子タグの関係性
- カテゴリー別の自動分類

### 2. AIによるタグ推奨
- 作品内容からの自動タグ生成
- 関連タグの提案機能

### 3. ユーザーのタグフォロー
- 特定タグをフォローして新着通知
- タグベースのレコメンデーション

---

## 実装時の注意事項

1. **UI/UXガイドライン準拠**: cursor-pointer、hover効果を必須で適用
2. **アクセシビリティ**: スクリーンリーダー対応、キーボード操作対応
3. **レスポンシブ対応**: モバイル・デスクトップ両方での最適表示
4. **パフォーマンス**: 大量タグでのスクロール性能考慮
5. **国際化対応**: 将来的な多言語対応を考慮した設計